@model Payment
@{
    var euroCulture = System.Globalization.CultureInfo.CreateSpecificCulture("nl-NL");
    var payments = ViewBag.ExistingPayments as List<OrderingSystemProject.Models.Payment> ?? new List<OrderingSystemProject.Models.Payment>();
}


<h2>Pay Now</h2>

<p><strong>Order Total:</strong> @Model.Bill.OrderTotal.ToString("C", euroCulture)</p>

<form asp-action="Pay" method="post">
    @Html.HiddenFor(m => m.BillId)
    <input type="hidden" name="OrderTotal" value="@Model.Bill.OrderTotal" />

    <!-- Tip selection with JavaScript to update total -->
    <div class="form-group py-2">
        <label>Tip:</label><br />
        <input type="radio" name="SelectedTipOption" value="0.2" onclick="handleTipSelection(this)"> 20%
        <input type="radio" name="SelectedTipOption" value="0.1" onclick="handleTipSelection(this)"> 10%
        <input type="radio" name="SelectedTipOption" value="0" onclick="handleTipSelection(this)"> Not Today
        <input type="radio" name="SelectedTipOption" value="custom" onclick="handleTipSelection(this)"> Custom Tip
    </div>
    
    <div id="customTipContainer" style="display:none;">
        <label>Enter custom tip (€):</label>
        <input type="number" name="CustomTipAmount" id="customTipValue" step="0.01" min="0" oninput="applyCustomTip()" />
    </div>
    <span asp-validation-for="CustomTipAmount" class="text-danger"></span>

    <p><strong>Final Payment Total:</strong> <span id="totalDisplay">€@Model.PaymentAmount</span></p>
    <input type="hidden" id="PaymentAmount" name="PaymentAmount" value="@Model.PaymentAmount" />

    <!-- Payment method -->
    <div class="form-group py-2">
        <label>Payment Method:</label><br />
        @Html.RadioButtonFor(m => m.PaymentType, PaymentType.Cash) Cash
        @Html.RadioButtonFor(m => m.PaymentType, PaymentType.CreditCard) Credit Card
        @Html.RadioButtonFor(m => m.PaymentType, PaymentType.DebitCard) Debit Card
    </div>

    <!-- Feedback textarea (fixed) -->
    <div class="form-group py-2">
        <label>Feedback:</label><br />
        <textarea asp-for="Feedback" rows="5" cols="50" placeholder="The food was wonderful!"></textarea>
    </div>

    <button type="submit" class="btn btn-success">Submit Payment</button>
</form>
<!-- Split Payment Options -->
<div class="mt-4">
    <h4>Want to split the bill?</h4>
    <a asp-action="SplitEqually" asp-route-id="@Model.Bill.BillId" class="btn btn-outline-primary me-2">
        Split Equally
    </a>
    <a asp-action="ProcessSplitPayment" asp-route-billId="@Model.Bill.BillId" class="btn btn-outline-secondary">
        Split by Custom Amounts
    </a>
</div>

@if (payments.Any())
{
    <h4>Payments already made:</h4>
    <table class="table table-bordered">
        <thead>
        <tr>
            <th>Payment ID</th>
            <th>Amount Paid</th>
            <th>Tip</th>
            <th>Payment Type</th>
            <th>Feedback</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var pay in payments)
        {
            <tr>
                <td>@pay.PaymentId</td>
                <td>@pay.PaymentAmount.ToString("C", euroCulture)</td>
                <td>@pay.TipAmount.ToString("C", euroCulture)</td>
                <td>@pay.PaymentType</td>
                <td>@pay.Feedback</td>
            </tr>
        }
        </tbody>
    </table>
}
else
{
    <p>No payments have been made yet.</p>
}

<!-- Basic JavaScript to update the payment amount automatically when the user presses the desired tip amount.  -->


<script>
    const orderTotal = parseFloat("@Model.Bill.OrderTotal");

    function handleTipSelection(radio) {
        const selectedValue = radio.value;

        if (selectedValue === "custom") {
            document.getElementById("customTipContainer").style.display = "block";
            applyCustomTip(); // In case there's already a value typed
        } else {
            document.getElementById("customTipContainer").style.display = "none";
            document.getElementById("customTipValue").value = "";

            const tipPercent = parseFloat(selectedValue);
            if (!isNaN(tipPercent)) {
                const tipAmount = orderTotal * tipPercent;
                updateTotalDisplay(tipAmount);
            }
        }
    }

    function applyCustomTip() {
        const customTip = parseFloat(document.getElementById("customTipValue").value) || 0;
        updateTotalDisplay(customTip);
    }

    function updateTotalDisplay(tipAmount) {
        const total = orderTotal + tipAmount;
        document.getElementById("totalDisplay").innerText = "€" + total.toFixed(2);
        document.getElementById("PaymentAmount").value = total.toFixed(2);
    }

    document.addEventListener("DOMContentLoaded", function () {
        const selected = document.querySelector('input[name="SelectedTipOption"]:checked');
        if (selected) handleTipSelection(selected);
    });
</script>