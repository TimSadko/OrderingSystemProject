@model Payment
@{
    var euroCulture = System.Globalization.CultureInfo.CreateSpecificCulture("nl-NL");
    var payments = ViewBag.ExistingPayments as List<OrderingSystemProject.Models.Payment> ?? new List<OrderingSystemProject.Models.Payment>();
}


<h2>Pay Now</h2>

<p><strong>Order Total:</strong> @Model.Bill.OrderTotal.ToString("C", euroCulture)</p>

<form asp-action="Pay" method="post">
    @Html.HiddenFor(m => m.BillId)
    <input type="hidden" name="OrderTotal" value="@Model.Bill.OrderTotal" />

    <!-- Tip selection with JavaScript to update total -->
    <div class="form-group py-2">
        <label>Tip:</label><br />
        @Html.RadioButtonFor(m => m.SelectedTipAmount, 0.2m, new { @onclick = "updatePaymentTotal()" }) 20%
        @Html.RadioButtonFor(m => m.SelectedTipAmount, 0.1m, new { @onclick = "updatePaymentTotal()" }) 10%
        @Html.RadioButtonFor(m => m.SelectedTipAmount, 0m, new { @onclick = "updatePaymentTotal()" }) Not Today
    </div>

    <p><strong>Final Payment Total:</strong> <span id="totalDisplay">€@Model.PaymentAmount</span></p>
    <input type="hidden" id="PaymentAmount" name="PaymentAmount" value="@Model.PaymentAmount" />

    <!-- Payment method -->
    <div class="form-group py-2">
        <label>Payment Method:</label><br />
        @Html.RadioButtonFor(m => m.PaymentType, PaymentType.Cash) Cash
        @Html.RadioButtonFor(m => m.PaymentType, PaymentType.CreditCard) Credit Card
        @Html.RadioButtonFor(m => m.PaymentType, PaymentType.DebitCard) Debit Card
    </div>

    <!-- Feedback textarea (fixed) -->
    <div class="form-group py-2">
        <label>Feedback:</label><br />
        <textarea asp-for="Feedback" rows="5" cols="50" placeholder="The food was wonderful!"></textarea>
    </div>

    <button type="submit" class="btn btn-success">Submit Payment</button>
</form>
<!-- Split Payment Options -->
<div class="mt-4">
    <h4>Want to split the bill?</h4>
    <a asp-action="SplitEqually" asp-route-id="@Model.Bill.BillId" class="btn btn-outline-primary me-2">
        Split Equally
    </a>
    <a asp-action="ProcessSplitPayment" asp-route-billId="@Model.Bill.BillId" class="btn btn-outline-secondary">
        Split by Custom Amounts
    </a>
</div>

@if (payments.Any())
{
    <h4>Payments already made:</h4>
    <table class="table table-bordered">
        <thead>
        <tr>
            <th>Payment ID</th>
            <th>Amount Paid</th>
            <th>Tip</th>
            <th>Payment Type</th>
            <th>Feedback</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var pay in payments)
        {
            <tr>
                <td>@pay.PaymentId</td>
                <td>@pay.PaymentAmount.ToString("C", euroCulture)</td>
                <td>@pay.TipAmount.ToString("C", euroCulture)</td>
                <td>@pay.PaymentType</td>
                <td>@pay.Feedback</td>
            </tr>
        }
        </tbody>
    </table>
}
else
{
    <p>No payments have been made yet.</p>
}

<script>
    function updatePaymentTotal() {
        const orderTotal = parseFloat("@Model.Bill.OrderTotal");
        const selectedTip = document.querySelector('input[name="SelectedTipAmount"]:checked');
        const tipPercent = selectedTip ? parseFloat(selectedTip.value) : 0;
        const total = orderTotal + (orderTotal * tipPercent);

        document.getElementById("totalDisplay").innerText = "€" + total.toFixed(2);
        document.getElementById("PaymentAmount").value = total.toFixed(2);
    }

    document.addEventListener("DOMContentLoaded", updatePaymentTotal);
</script>